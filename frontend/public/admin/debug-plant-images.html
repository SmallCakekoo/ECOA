<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Im√°genes de Plantas - ECOA Admin</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .plant-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            background: #f9f9f9;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .plant-image {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            overflow: hidden;
            background: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .plant-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .plant-info {
            flex: 1;
        }
        .plant-info h4 {
            margin: 0 0 5px 0;
            color: #333;
        }
        .plant-info p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }
        .debug-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            background: #e9ecef;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug Im√°genes de Plantas - ECOA Admin</h1>
        <p>Este debug verifica por qu√© algunas plantas no cargan im√°genes de la API de Perenual.</p>
        
        <button onclick="debugAllPlants()">üîç Debug Todas las Plantas</button>
        <button onclick="testPerenualAPI()">üß™ Probar API de Perenual</button>
        <button onclick="fixPlantImages()">üîß Arreglar Im√°genes</button>
        
        <div id="debugResult" class="result"></div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3001';
        
        async function debugAllPlants() {
            const resultDiv = document.getElementById('debugResult');
            resultDiv.innerHTML = 'üîÑ Debuggeando plantas...';
            
            try {
                // Obtener plantas de la base de datos
                const plantsResponse = await fetch(`${API_BASE_URL}/plants`);
                const plantsData = await plantsResponse.json();
                
                if (!plantsData.success) {
                    resultDiv.innerHTML = `<div class="error">‚ùå Error obteniendo plantas: ${plantsData.message}</div>`;
                    return;
                }
                
                const plants = plantsData.data;
                let html = `<h3>üå± Debug de Plantas (${plants.length})</h3>`;
                
                for (const plant of plants) {
                    html += `<div class="plant-card">`;
                    html += `<div class="plant-image"><img src="../../src/plant-placeholder.svg" alt="${plant.name}"></div>`;
                    html += `<div class="plant-info">`;
                    html += `<h4>${plant.name} (${plant.species})</h4>`;
                    html += `<p>ID: ${plant.id}</p>`;
                    html += `</div>`;
                    html += `</div>`;
                    
                    // Debug de b√∫squeda en Perenual
                    html += `<div class="debug-info">`;
                    html += `<strong>üîç Buscando en Perenual API para: "${plant.species}"</strong><br>`;
                    
                    try {
                        const perenualResponse = await fetch(`${API_BASE_URL}/api/integrations/perenual/search?q=${encodeURIComponent(plant.species)}&limit=1`);
                        const perenualData = await perenualResponse.json();
                        
                        html += `<strong>Status:</strong> ${perenualResponse.status}<br>`;
                        html += `<strong>Success:</strong> ${perenualData.success}<br>`;
                        
                        if (perenualData.success && perenualData.search_results?.plants?.length > 0) {
                            const perenualPlant = perenualData.search_results.plants[0];
                            html += `<strong>‚úÖ Planta encontrada:</strong> ${perenualPlant.common_name || perenualPlant.scientific_name}<br>`;
                            
                            if (perenualPlant.default_image) {
                                html += `<strong>üñºÔ∏è Imagen disponible:</strong><br>`;
                                html += `- Thumbnail: ${perenualPlant.default_image.thumbnail || 'No disponible'}<br>`;
                                html += `- Small URL: ${perenualPlant.default_image.small_url || 'No disponible'}<br>`;
                                html += `- Medium URL: ${perenualPlant.default_image.medium_url || 'No disponible'}<br>`;
                                
                                // Mostrar la imagen encontrada
                                const imageUrl = perenualPlant.default_image.thumbnail || perenualPlant.default_image.small_url;
                                if (imageUrl) {
                                    html += `<img src="${imageUrl}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 5px; margin: 5px 0;">`;
                                }
                            } else {
                                html += `<strong>‚ùå No hay imagen disponible</strong><br>`;
                            }
                        } else {
                            html += `<strong>‚ùå No se encontraron plantas para "${plant.species}"</strong><br>`;
                            html += `<strong>Error:</strong> ${perenualData.message || 'Desconocido'}<br>`;
                        }
                    } catch (error) {
                        html += `<strong>‚ùå Error en la b√∫squeda:</strong> ${error.message}<br>`;
                    }
                    
                    html += `</div>`;
                }
                
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        async function testPerenualAPI() {
            const resultDiv = document.getElementById('debugResult');
            resultDiv.innerHTML = 'üß™ Probando API de Perenual...';
            
            try {
                // Probar b√∫squedas espec√≠ficas
                const testSearches = [
                    'Monstera deliciosa',
                    'Ficus lyrata',
                    'Monstera',
                    'Ficus'
                ];
                
                let html = `<h3>üß™ Test de API de Perenual</h3>`;
                
                for (const searchTerm of testSearches) {
                    html += `<div class="debug-info">`;
                    html += `<strong>Buscando: "${searchTerm}"</strong><br>`;
                    
                    try {
                        const response = await fetch(`${API_BASE_URL}/api/integrations/perenual/search?q=${encodeURIComponent(searchTerm)}&limit=3`);
                        const data = await response.json();
                        
                        html += `Status: ${response.status}<br>`;
                        html += `Success: ${data.success}<br>`;
                        
                        if (data.success && data.search_results?.plants?.length > 0) {
                            html += `‚úÖ Encontradas ${data.search_results.plants.length} plantas<br>`;
                            
                            data.search_results.plants.forEach((plant, index) => {
                                html += `<div style="margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">`;
                                html += `<strong>Planta ${index + 1}:</strong><br>`;
                                html += `- Nombre com√∫n: ${plant.common_name || 'N/A'}<br>`;
                                html += `- Nombre cient√≠fico: ${plant.scientific_name || 'N/A'}<br>`;
                                
                                if (plant.default_image) {
                                    const imageUrl = plant.default_image.thumbnail || plant.default_image.small_url;
                                    if (imageUrl) {
                                        html += `- Imagen: <img src="${imageUrl}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 3px; vertical-align: middle;">`;
                                    } else {
                                        html += `- Imagen: No disponible<br>`;
                                    }
                                } else {
                                    html += `- Imagen: No disponible<br>`;
                                }
                                html += `</div>`;
                            });
                        } else {
                            html += `‚ùå No se encontraron plantas<br>`;
                            html += `Error: ${data.message || 'Desconocido'}<br>`;
                        }
                    } catch (error) {
                        html += `‚ùå Error: ${error.message}<br>`;
                    }
                    
                    html += `</div>`;
                }
                
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        async function fixPlantImages() {
            const resultDiv = document.getElementById('debugResult');
            resultDiv.innerHTML = 'üîß Arreglando im√°genes de plantas...';
            
            try {
                // Obtener plantas
                const plantsResponse = await fetch(`${API_BASE_URL}/plants`);
                const plantsData = await plantsResponse.json();
                
                if (!plantsData.success) {
                    resultDiv.innerHTML = `<div class="error">‚ùå Error obteniendo plantas: ${plantsData.message}</div>`;
                    return;
                }
                
                const plants = plantsData.data;
                let html = `<h3>üîß Arreglando Im√°genes</h3>`;
                
                for (const plant of plants) {
                    html += `<div class="debug-info">`;
                    html += `<strong>Procesando: ${plant.name} (${plant.species})</strong><br>`;
                    
                    // Intentar diferentes t√©rminos de b√∫squeda
                    const searchTerms = [
                        plant.species,
                        plant.name,
                        plant.species.split(' ')[0], // Solo el g√©nero
                        plant.species.split(' ').slice(0, 2).join(' ') // G√©nero + especie
                    ];
                    
                    let foundImage = null;
                    let bestMatch = null;
                    
                    for (const term of searchTerms) {
                        if (!term) continue;
                        
                        try {
                            const response = await fetch(`${API_BASE_URL}/api/integrations/perenual/search?q=${encodeURIComponent(term)}&limit=1`);
                            const data = await response.json();
                            
                            if (data.success && data.search_results?.plants?.length > 0) {
                                const perenualPlant = data.search_results.plants[0];
                                if (perenualPlant.default_image) {
                                    const imageUrl = perenualPlant.default_image.thumbnail || perenualPlant.default_image.small_url;
                                    if (imageUrl) {
                                        foundImage = imageUrl;
                                        bestMatch = perenualPlant.common_name || perenualPlant.scientific_name;
                                        html += `‚úÖ Encontrada con "${term}": ${bestMatch}<br>`;
                                        html += `üñºÔ∏è Imagen: <img src="${imageUrl}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 3px; vertical-align: middle;"><br>`;
                                        break;
                                    }
                                }
                            }
                        } catch (error) {
                            html += `‚ùå Error con "${term}": ${error.message}<br>`;
                        }
                    }
                    
                    if (!foundImage) {
                        html += `‚ùå No se pudo encontrar imagen para ${plant.name}<br>`;
                    }
                    
                    html += `</div>`;
                }
                
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        // Debug autom√°tico al cargar
        window.onload = debugAllPlants;
    </script>
</body>
</html>
